# Whisper-for-Subs æ”¹é€²èªªæ˜

## æ”¹é€²æ—¥æœŸ
2026-01-12

## æ”¹é€²æ¦‚è¿°

é‡å°å¤šç”¨æˆ¶ä¸¦ç™¼è™•ç†å’Œæª”æ¡ˆæ¸…ç†æ©Ÿåˆ¶é€²è¡Œäº†å…¨é¢æ”¹é€²ï¼Œè§£æ±ºäº†åŸå§‹ç‰ˆæœ¬ä¸­çš„æ½›åœ¨å•é¡Œã€‚

---

## ğŸ”§ ä¸»è¦æ”¹é€²

### 1. TranscriberPool - å¤šç”¨æˆ¶éš”é›¢æ©Ÿåˆ¶

**å•é¡Œï¼š** åŸç‰ˆä½¿ç”¨å…¨å±€ transcriber å¯¦ä¾‹ï¼Œå¤šå€‹ç”¨æˆ¶åŒæ™‚ä½¿ç”¨æœƒäº’ç›¸å¹²æ“¾ã€‚

**è§£æ±ºæ–¹æ¡ˆï¼š** å¯¦ä½œäº† `TranscriberPool` é¡åˆ¥

```python
class TranscriberPool:
    """
    Thread-safe pool for managing transcriber instances.
    Ensures each concurrent request can use an isolated transcriber.
    """
```

**ç‰¹æ€§ï¼š**
- âœ… åŸ·è¡Œç·’å®‰å…¨çš„è³‡æºæ± ç®¡ç†
- âœ… æ”¯æ´æœ€å¤š 2 å€‹ä¸¦ç™¼è«‹æ±‚ï¼ˆå¯èª¿æ•´ï¼‰
- âœ… è‡ªå‹•é‡ç”¨é–’ç½®çš„ transcriber
- âœ… è«‹æ±‚å®Œæˆå¾Œè‡ªå‹•é‡‹æ”¾è³‡æº
- âœ… å–® GPU å’Œå¤š GPU æ¨¡å¼åˆ†åˆ¥ç®¡ç†

**æ•ˆæœï¼š**
- å…©å€‹ç”¨æˆ¶åŒæ™‚è½‰éŒ„ä¸åŒéŸ³æª”æ™‚ï¼Œä½¿ç”¨å„è‡ªç¨ç«‹çš„ transcriber å¯¦ä¾‹
- é¿å…æ¨¡å‹ç‹€æ…‹äº’ç›¸æ±¡æŸ“
- æå‡ä¸¦ç™¼è™•ç†çš„å¯é æ€§

---

### 2. Session-based æª”æ¡ˆç®¡ç†

**å•é¡Œï¼š** 
- YouTube ä¸‹è¼‰ä½¿ç”¨ `video_id` å‘½åï¼Œç›¸åŒå½±ç‰‡æœƒè¡çª
- ç”¨æˆ¶ä¸Šå‚³çš„æª”æ¡ˆç›´æ¥ä½¿ç”¨åŸè·¯å¾‘ï¼Œæ²’æœ‰éš”é›¢

**è§£æ±ºæ–¹æ¡ˆï¼š** ç‚ºæ¯å€‹è«‹æ±‚å‰µå»ºç¨ç«‹çš„ session ç›®éŒ„

```python
session_id = uuid.uuid4().hex[:12]
session_dir = os.path.join("/tmp/whisper-sessions", session_id)
```

**ç‰¹æ€§ï¼š**
- âœ… æ¯å€‹è«‹æ±‚æœ‰å”¯ä¸€çš„ session ID
- âœ… ç¨ç«‹çš„å·¥ä½œç›®éŒ„ `/tmp/whisper-sessions/{session_id}/`
- âœ… ç”¨æˆ¶ä¸Šå‚³çš„æª”æ¡ˆæœƒè¤‡è£½åˆ° session ç›®éŒ„
- âœ… YouTube ä¸‹è¼‰ä¹Ÿæ”¾åœ¨ session å­ç›®éŒ„
- âœ… è™•ç†å®Œæˆå¾Œè‡ªå‹•æ¸…ç†æ•´å€‹ session ç›®éŒ„

**æª”æ¡ˆçµæ§‹ï¼š**
```
/tmp/whisper-sessions/
â”œâ”€â”€ abc123def456/          # Session 1
â”‚   â”œâ”€â”€ downloads/
â”‚   â”‚   â””â”€â”€ video_id.wav
â”‚   â””â”€â”€ upload_xyz.mp3
â””â”€â”€ 789ghi012jkl/          # Session 2
    â””â”€â”€ upload_abc.wav
```

---

### 3. å¢å¼·çš„æª”æ¡ˆæ¸…ç†æ©Ÿåˆ¶

**æ”¹é€²å‰ï¼š**
- âœ… YouTube ä¸‹è¼‰æª”æ¡ˆæœƒæ¸…ç†
- âœ… è¼¸å‡º SRT æª”æ¡ˆæœƒå®šæœŸæ¸…ç†
- âŒ ç”¨æˆ¶ä¸Šå‚³çš„æª”æ¡ˆä¸æœƒæ¸…ç†
- âŒ æ²’æœ‰ session ç›®éŒ„çš„æ¦‚å¿µ

**æ”¹é€²å¾Œï¼š**
```python
finally:
    # 1. é‡‹æ”¾ transcriber å›è³‡æºæ± 
    if worker_id:
        transcriber_pool.release_*_transcriber(worker_id)
    
    # 2. æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
    for f in temp_files:
        os.unlink(f)
    
    # 3. æ¸…ç†æ•´å€‹ session ç›®éŒ„
    shutil.rmtree(session_dir)
```

**æ–°å¢æ¸…ç†ç¯„åœï¼š**
- âœ… `/tmp/whisper-downloads/*` - YouTube ä¸‹è¼‰
- âœ… `/app/outputs/*.srt` - è¼¸å‡ºå­—å¹•
- âœ… `/tmp/whisper-sessions/*` - **æ–°å¢ï¼šæ‰€æœ‰ session ç›®éŒ„**
- âœ… ç”¨æˆ¶ä¸Šå‚³æª”æ¡ˆçš„è‡¨æ™‚è¤‡è£½ - **æ–°å¢**

**æ¸…ç†æ™‚æ©Ÿï¼š**
1. **å³æ™‚æ¸…ç†ï¼š** æ¯å€‹è«‹æ±‚çµæŸæ™‚æ¸…ç†è©² session çš„æ‰€æœ‰æª”æ¡ˆ
2. **å®šæœŸæ¸…ç†ï¼š** æ¯æ¬¡è™•ç†å‰æ¸…ç†è¶…é 24 å°æ™‚çš„èˆŠæª”æ¡ˆ
3. **å•Ÿå‹•æ¸…ç†ï¼š** æœå‹™å•Ÿå‹•æ™‚æ¸…ç†èˆŠæª”æ¡ˆ

---

### 4. UUID æª”æ¡ˆå‘½åé˜²è¡çª

**å•é¡Œï¼š** è¼¸å‡ºæª”æ¡ˆåªç”¨æ¨™é¡Œ+æ™‚é–“æˆ³ï¼Œé«˜ä¸¦ç™¼ä¸‹ä»å¯èƒ½è¡çª

**è§£æ±ºæ–¹æ¡ˆï¼š** åŠ å…¥ UUID ç¢ºä¿å”¯ä¸€æ€§

```python
# æ”¹é€²å‰
srt_filename = f"{safe_title}_{timestamp}.srt"

# æ”¹é€²å¾Œ
unique_id = uuid.uuid4().hex[:6]
srt_filename = f"{safe_title}_{timestamp}_{unique_id}.srt"
```

**ç¯„ä¾‹ï¼š**
```
youtube_audio_20260112_143025_a3f5d2.srt
my_recording_20260112_143026_b7e9c1.srt
```

---

### 5. è©³ç´°çš„æ—¥èªŒè¨˜éŒ„

æ–°å¢äº†å®Œæ•´çš„è™•ç†æ—¥èªŒï¼š

```
============================================================
ğŸ¬ Starting session: abc123def456
============================================================

ğŸ“ Uploaded file copied to session: /tmp/whisper-sessions/abc123def456/upload_xyz.mp3
â±ï¸  Audio duration: 180.5s
ğŸ”§ Using single-GPU transcriber: single_a1b2c3d4
ğŸ“ Generated 45 segments
ğŸ”— Merged from 45 to 32 segments
ğŸ’¾ SRT saved: /app/outputs/my_audio_20260112_143025_a3f5d2.srt
ğŸ§¹ Cleaned temp file: /tmp/whisper-sessions/abc123def456/upload_xyz.mp3
ğŸ§¹ Cleaned session directory: /tmp/whisper-sessions/abc123def456

============================================================
âœ… Session completed: abc123def456
â±ï¸  Total time: 45.2s
============================================================
```

---

## ğŸ“Š æ”¹é€²å°æ¯”

| é …ç›® | æ”¹é€²å‰ | æ”¹é€²å¾Œ |
|------|--------|--------|
| **å¤šç”¨æˆ¶å¹²æ“¾** | âš ï¸ å…±äº«å…¨å±€å¯¦ä¾‹ | âœ… ç¨ç«‹ transcriber å¯¦ä¾‹ |
| **æª”æ¡ˆè¡çª** | âš ï¸ å¯èƒ½ç™¼ç”Ÿ | âœ… UUID ç¢ºä¿å”¯ä¸€ |
| **ä¸Šå‚³æª”æ¡ˆæ¸…ç†** | âŒ ä¸æ¸…ç† | âœ… è‡ªå‹•æ¸…ç† |
| **Session éš”é›¢** | âŒ ç„¡ | âœ… å®Œæ•´éš”é›¢ |
| **è³‡æºå›æ”¶** | âš ï¸ éƒ¨åˆ† | âœ… å®Œæ•´å›æ”¶ |
| **æ—¥èªŒè¿½è¹¤** | âš ï¸ ç°¡å–® | âœ… è©³ç´°å®Œæ•´ |

---

## ğŸ§ª æ¸¬è©¦å»ºè­°

### æ¸¬è©¦å ´æ™¯ 1ï¼šä¸¦ç™¼ä½¿ç”¨
1. é–‹å•Ÿå…©å€‹ç€è¦½å™¨åˆ†é 
2. åŒæ™‚ä¸Šå‚³ä¸åŒçš„éŸ³æª”
3. ç¢ºèªå…©å€‹è«‹æ±‚éƒ½èƒ½æ­£å¸¸å®Œæˆä¸”çµæœä¸äº’ç›¸å¹²æ“¾

### æ¸¬è©¦å ´æ™¯ 2ï¼šç›¸åŒå½±ç‰‡
1. å…©å€‹ç”¨æˆ¶åŒæ™‚ä¸‹è¼‰ç›¸åŒçš„ YouTube å½±ç‰‡
2. ç¢ºèªæ²’æœ‰æª”æ¡ˆè¡çªéŒ¯èª¤
3. å…©å€‹è«‹æ±‚éƒ½èƒ½ç¨ç«‹å®Œæˆ

### æ¸¬è©¦å ´æ™¯ 3ï¼šæª”æ¡ˆæ¸…ç†
1. è™•ç†å®Œä¸€å€‹éŸ³æª”
2. æª¢æŸ¥ `/tmp/whisper-sessions/` æ˜¯å¦å·²æ¸…ç©ºè©² session
3. æª¢æŸ¥ç”¨æˆ¶ä¸Šå‚³çš„åŸå§‹æª”æ¡ˆæ˜¯å¦ä¿æŒä¸è®Š

### æ¸¬è©¦å ´æ™¯ 4ï¼šé•·æ™‚é–“é‹è¡Œ
1. è®“æœå‹™é‹è¡Œ 24 å°æ™‚ä»¥ä¸Š
2. ç¢ºèªèˆŠæª”æ¡ˆè¢«è‡ªå‹•æ¸…ç†
3. ç¢ºèªæ²’æœ‰ç£ç¢Ÿç©ºé–“é€æ¼¸è€—ç›¡çš„å•é¡Œ

---

## ğŸ” ç¨‹å¼ç¢¼è®Šæ›´æ‘˜è¦

### æ–°å¢é¡åˆ¥
- `TranscriberPool`: ç®¡ç† transcriber å¯¦ä¾‹æ± 

### ä¿®æ”¹å‡½æ•¸
- `process_audio()`: 
  - æ–°å¢ session ç®¡ç†
  - æ–°å¢è‡¨æ™‚æª”æ¡ˆè¤‡è£½
  - å¢å¼·éŒ¯èª¤è™•ç†å’Œæ¸…ç†
  - æ–°å¢è©³ç´°æ—¥èªŒ

- `cleanup_old_files()`:
  - æ–°å¢æ¸…ç† `/tmp/whisper-sessions/`

- `get_system_info()`:
  - æ–°å¢æ”¹é€²èªªæ˜

### å…¨å±€è®Šæ•¸è®Šæ›´
- ç§»é™¤ï¼š`transcriber`, `parallel_transcriber`
- æ–°å¢ï¼š`transcriber_pool`

---

## âš™ï¸ è¨­å®šåƒæ•¸

å¯é€é `TranscriberPool` åˆå§‹åŒ–èª¿æ•´ä¸¦ç™¼æ•¸ï¼š

```python
# åœ¨ app.py ä¸­
transcriber_pool = TranscriberPool(max_workers=2)  # æœ€å¤š 2 å€‹ä¸¦ç™¼
```

å»ºè­°è¨­å®šï¼š
- **å°å‹éƒ¨ç½²ï¼ˆå–® GPUï¼‰ï¼š** `max_workers=1-2`
- **å¤š GPU ä¼ºæœå™¨ï¼š** `max_workers=2-4`ï¼ˆå–æ±ºæ–¼ GPU æ•¸é‡å’Œè¨˜æ†¶é«”ï¼‰

---

## ğŸ“ æ³¨æ„äº‹é …

1. **è¨˜æ†¶é«”ä½¿ç”¨ï¼š** æ¯å€‹ transcriber å¯¦ä¾‹æœƒä½”ç”¨ GPU è¨˜æ†¶é«”ï¼Œmax_workers è¨­å®šéœ€è€ƒæ…® GPU è¨˜æ†¶é«”å®¹é‡

2. **ç£ç¢Ÿç©ºé–“ï¼š** Session ç›®éŒ„æœƒæš«æ™‚ä½”ç”¨ç£ç¢Ÿç©ºé–“ï¼Œå»ºè­°å®šæœŸç›£æ§ `/tmp/` ä½¿ç”¨é‡

3. **æ•ˆèƒ½è€ƒé‡ï¼š** é›–ç„¶æ”¯æ´ä¸¦ç™¼ï¼Œä½†å¯¦éš›è™•ç†é€Ÿåº¦ä»å—é™æ–¼ GPU é‹ç®—èƒ½åŠ›

4. **å‘å¾Œç›¸å®¹ï¼š** æ‰€æœ‰åŸæœ‰åŠŸèƒ½ä¿æŒä¸è®Šï¼Œåªæ˜¯å…§éƒ¨å¯¦ä½œæ”¹é€²

---

## ğŸ¯ æœªä¾†æ”¹é€²å»ºè­°

1. **å‹•æ…‹è³‡æºèª¿æ•´ï¼š** æ ¹æ“šç³»çµ±è² è¼‰è‡ªå‹•èª¿æ•´ max_workers
2. **å„ªå…ˆç´šä½‡åˆ—ï¼š** ç‚ºä¸åŒè«‹æ±‚è¨­å®šå„ªå…ˆç´š
3. **çµæœå¿«å–ï¼š** ç›¸åŒéŸ³æª”çš„è½‰éŒ„çµæœå¿«å–
4. **åˆ†æ•£å¼è™•ç†ï¼š** æ”¯æ´å¤šæ©Ÿå™¨æ©«å‘æ“´å±•
5. **ç›£æ§å„€è¡¨æ¿ï¼š** è¦–è¦ºåŒ–é¡¯ç¤ºç³»çµ±ç‹€æ…‹å’Œè«‹æ±‚è™•ç†æƒ…æ³

---

## ğŸ“ å•é¡Œå›å ±

å¦‚æœç™¼ç¾ä»»ä½•å•é¡Œï¼Œè«‹æä¾›ï¼š
- Session IDï¼ˆæœƒé¡¯ç¤ºåœ¨è™•ç†å®Œæˆçš„ç‹€æ…‹è¨Šæ¯ä¸­ï¼‰
- å®Œæ•´çš„éŒ¯èª¤è¨Šæ¯
- æ—¥èªŒè¼¸å‡º

---

**æ”¹é€²å®Œæˆï¼** ğŸ‰

ç¾åœ¨ç³»çµ±å¯ä»¥å®‰å…¨åœ°è™•ç†å¤šç”¨æˆ¶ä¸¦ç™¼è«‹æ±‚ï¼Œä¸¦ç¢ºä¿æ‰€æœ‰è‡¨æ™‚æª”æ¡ˆéƒ½æœƒè¢«æ­£ç¢ºæ¸…ç†ã€‚
